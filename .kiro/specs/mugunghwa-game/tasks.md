# 무궁화 게임 시스템 구현 계획

## 구현 작업 목록

- [x] 1. 프로젝트 기본 구조 및 헤더 파일 설정
  - Arduino IDE 프로젝트 구조 생성 (Master/Slave 분리)
  - 매크로 정의 헤더 파일 작성 (master_config.h, slave_config.h)
  - 공통 통신 프로토콜 헤더 파일 작성 (communication.h)
  - 기본 라이브러리 include 및 초기 설정
  - _요구사항: 7.3, 7.4, 7.5_

- [x] 2. Master Board 기본 하드웨어 제어 구현
  - [x] 2.1 PIR 센서 입력 처리 구현
    - PIR 센서 4개 디지털 입력 읽기 함수 작성 (완료)
    - 동작 감지 상태 관리 및 디바운싱 처리 (완료)
    - 센서별 개별 상태 확인 기능 구현 (완료)
    - _요구사항: 3.2, 7.1_

  - [x] 2.2 천정 조명 제어 구현
    - 4개 천정 조명 개별 제어 함수 작성 (완료)
    - 순차 점등 패턴 구현 (게임 시작용) (완료)
    - 조명 상태 관리 및 타이밍 제어 (완료)
    - _요구사항: 1.2, 1.3_

  - [x] 2.3 경광등 제어 구현
    - 초록색/빨간색 경광등 릴레이 제어 함수 작성 (완료)
    - 경광등 상태 전환 로직 구현 (완료)
    - 타이밍 기반 자동 제어 기능 (완료)
    - _요구사항: 2.1, 3.1_

- [x] 3. Master Board 이펙트 LED 패턴 시스템 구현
  - [x] 3.1 이펙트 LED 기본 제어 구현
    - 6개 이펙트 LED 릴레이 제어 함수 작성 (완료)
    - LED 마스크 기반 개별/그룹 제어 기능 (완료)
    - 릴레이 스위칭 타이밍 최적화 및 안정성 확보 (완료)
    - _요구사항: 6.2_

  - [x] 3.2 이펙트 패턴 엔진 구현
    - EffectSequence 구조체 기반 패턴 재생 엔진 작성 (완료)
    - 6가지 상황별 패턴 데이터 정의 (SUCCESS, ERROR, LEVEL_UP, GAME_START, GAME_CLEAR, TENSION) (완료)
    - 비동기 패턴 실행 및 타이머 관리 시스템 (완료)
    - 패턴 중단 및 전환 기능 구현 (완료)
    - _요구사항: 8.1, 8.3_

- [x] 4. Master Board 오디오 시스템 구현
  - DFPlayer Mini 초기화 및 제어 함수 작성 (완료)
  - 내레이션 및 BGM 재생 기능 구현 (완료)
  - 오디오 트랙 관리 및 볼륨 제어 (완료)
  - 재생 상태 확인 및 에러 처리 (완료)
  - _요구사항: 1.5, 6.3, 7.4_

- [x] 5. Master Board 시리얼 통신 구현
  - [x] 5.1 통신 프로토콜 기본 구현
    - SerialMessage 구조체 기반 메시지 송수신 함수 작성 (완료)
    - 체크섬 검증 및 에러 처리 로직 구현 (완료)
    - 명령어 인코딩/디코딩 함수 작성 (완료)
    - _요구사항: 7.3_

  - [x] 5.2 Master-Slave 명령 처리 구현
    - Slave로 명령 전송 함수 구현 (로봇 제어, LED 패턴, 효과음) (완료)
    - Slave로부터 응답 수신 및 처리 함수 구현 (완료)
    - 통신 타임아웃 및 재시도 메커니즘 구현 (완료)
    - _요구사항: 7.3_

- [x] 6. Slave Board 모터 제어 시스템 구현
  - [x] 6.1 DC 모터 기본 제어 구현
    - L298N 드라이버를 통한 Head/Body 모터 제어 함수 작성 (완료)
    - 모터 회전 방향 및 속도 제어 구현 (완료)
    - 모터 정지 및 브레이크 시스템 구현 (5초간 HIGH 신호) (완료)
    - _요구사항: 7.2_

  - [x] 6.2 리미트 스위치 기반 위치 제어 구현
    - MCP23017을 통한 리미트 스위치 상태 읽기 함수 작성 (완료)
    - 로봇 Head/Body 정확한 위치 제어 로직 구현 (완료)
    - 위치 도달 감지 및 자동 정지 기능 (완료)
    - 안전장치: 리미트 스위치 오작동 시 타이머 백업 정지 (완료)
    - _요구사항: 1.4, 2.6, 3.6, 7.6_

- [x] 7. Slave Board 입력 처리 시스템 구현
  - [x] 7.1 진동 센서 입력 처리 구현
    - 4개 진동 센서 아날로그 값 읽기 함수 작성 (완료)
    - 진동 임계값 설정 및 발판 감지 로직 구현 (완료)
    - 진동 센서 디바운싱 및 노이즈 필터링 처리 (완료)
    - 발판별 입력 순서 추적 및 검증 기능 (완료)
    - _요구사항: 2.4, 7.1_

- [x] 8. Slave Board 통신 처리 구현
  - Master로부터 명령 수신 및 파싱 함수 작성 (완료)
  - 명령별 처리 로직 구현 (모터 제어, LED 제어, 효과음 재생) (완료)
  - Master로 응답 및 상태 전송 함수 구현 (완료)
  - _요구사항: 7.3_

- [x] 9. Slave Board LED 제어 시스템 구현
  - [x] 9.1 문제 제시 LED 제어 구현
    - MCP23017을 통한 4개 문제 LED 개별 제어 함수 작성 (완료)
    - LEDPattern 구조체 기반 패턴 표시 기능 구현 (완료)
    - 레벨별 패턴 생성 로직 (연속 LED 방지 포함) (완료)
    - 패턴 재생 타이밍 제어 및 효과음 동기화 (완료)
    - _요구사항: 2.2, 2.3, 5.2, 5.3, 5.4_

  - [x] 9.2 점수 LED 제어 구현
    - MCP23017을 통한 6개 점수 LED 제어 함수 작성 (완료)
    - 점수 증감에 따른 LED 상태 업데이트 로직 (완료)
    - 7점 달성 시 특별 점멸 패턴 구현 (0.5초 간격 7회) (완료)
    - _요구사항: 4.2, 4.3, 4.6_

- [x] 10. Slave Board 효과음 재생 시스템 구현
  - DFPlayer Mini를 통한 효과음 재생 함수 작성 (완료)
  - 상황별 효과음 매핑 및 재생 로직 구현 (완료)
  - 오디오 재생 상태 관리 및 중복 재생 방지 (완료)
  - _요구사항: 1.3, 2.4, 3.3, 7.5_

- [x] 11. Master Board 게임 상태 관리 시스템 구현
  - [x] 11.1 게임 상태 머신 구현
    - GameState 구조체 기반 상태 관리 시스템 작성 (완료)
    - 게임 단계별 상태 전환 로직 구현 (IDLE → GAME_START → ... → GAME_CLEAR) (완료)
    - 각 상태에서의 하드웨어 제어 및 타이밍 관리 (완료)
    - _요구사항: 1.1, 6.1_

  - [x] 11.2 점수 및 레벨 관리 구현
    - 점수 증감 로직 및 0점 하한선 처리 구현 (완료)
    - 레벨 진행 시스템 (1-11레벨, 순환 구조) 구현 (완료)
    - 레벨별 난이도 조절 로직 (패턴 길이, 속도 변경) (완료)
    - _요구사항: 4.1, 4.4, 4.5, 5.1, 5.5_

- [x] 12. Master Board PIR 센서 동작 감지 구현
  - [x] 12.1 PIR 센서 실제 동작 감지 로직 구현
    - 4개 PIR 센서 실시간 모니터링 및 상태 변화 감지 (완료)
    - 구역별(A,B,C,D) 동작 감지 통합 처리 (완료)
    - 동작 감지 시 이벤트 트리거 및 처벌 시스템 연동 (완료)
    - _요구사항: 3.2, 3.4, 3.5_

  - [x] 12.2 천정 조명 순차 점등 구현
    - 게임 시작 시 천정 조명 1-4번 순차 점등 로직 (완료)
    - 각 조명별 효과음 동기화 재생 (완료)
    - 점등 완료 후 로봇 회전 신호 전송 (완료)
    - _요구사항: 1.2, 1.3_

  - [x] 12.3 경광등 게임 상태 연동 구현
    - 로봇 후면 회전 시 초록 경광등 자동 점등 (완료)
    - 로봇 정면 회전 시 빨간 경광등 자동 점등 (완료)
    - 동작 감지 완료 후 경광등 자동 소등 (완료)
    - _요구사항: 2.1, 3.1_

- [x] 13. Master Board 게임 상태 머신 함수 완성




  - [x] 13.1 게임 단계별 처리 함수 완성


    - handleGameStartPhase() 함수 완성 (천정 조명 완료 후 다음 단계 전환)
    - handleRobotTurnFrontPhase() 함수 완성 (로봇 회전 완료 대기)
    - handleNarrationPhase() 함수 완성 (내레이션 재생 완료 대기)
    - handleRobotTurnBackPhase() 함수 완성 (로봇 후면 회전 완료 대기)
    - _요구사항: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [x] 13.2 게임 라운드 진행 로직 완성


    - handleShowPatternPhase() 함수 완성 (패턴 표시 완료 후 입력 대기)
    - handlePlayerInputPhase() 함수 완성 (입력 결과 수신 및 처리)
    - handleScoreUpdatePhase() 함수 완성 (점수 업데이트 및 다음 라운드 판정)
    - handleMotionDetectPhase() 함수 완성 (HEAD 회전 및 감지 처리)
    - _요구사항: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

  - [x] 13.3 게임 클리어 및 종료 처리 완성


    - handleGameClearPhase() 함수 완성 (클리어 이펙트 및 EM-Lock 제어)
    - 게임 종료 후 IDLE 상태로 전환하는 로직 완성
    - _요구사항: 6.1, 6.2, 6.3, 6.4_

- [x] 14. Master Board 미완성 함수들 구현





  - [x] 14.1 오디오 및 이펙트 함수 구현


    - playWelcomeNarration() 함수 구현 (환영 내레이션 재생)
    - playGameClearNarration() 함수 구현 (클리어 내레이션 재생)
    - playGameStartEffect(), playErrorEffect(), playTensionEffect() 등 이펙트 함수 구현
    - stopTensionEffect() 함수 구현 (긴장 이펙트 중지)
    - _요구사항: 1.5, 6.3, 8.1, 8.3_

  - [x] 14.2 게임 로직 및 통신 함수 구현


    - showCurrentLevelPattern() 함수 구현 (현재 레벨 패턴 표시)
    - processScoreUpdate() 함수 구현 (점수 업데이트 처리)
    - setMotionDetectionResult() 함수 구현 (동작 감지 결과 설정)
    - activateEMLock() 함수 구현 (EM-Lock 작동)
    - processSlaveComm() 함수 구현 (Slave 통신 처리)
    - _요구사항: 2.2, 4.1, 6.4, 7.3_

  - [x] 14.3 유틸리티 함수 구현


    - getPhaseNameKorean() 함수 구현 (게임 단계 한국어 이름 반환)
    - processSerialCommands() 함수 구현 (시리얼 디버그 명령 처리)
    - updateDFPlayerStatus() 함수 구현 (DFPlayer 상태 모니터링)
    - playAudioTrack() 함수 구현 (DFPlayer 트랙 재생)
    - _요구사항: 7.4, 8.2_

- [x] 15. Slave Board 미완성 함수들 구현




  - [x] 15.1 모터 제어 함수 완성


    - rotateHeadForward(), rotateHeadBackward() 함수 완성 (리미트 스위치 연동)
    - rotateBodyForward(), rotateBodyBackward() 함수 완성 (리미트 스위치 연동)
    - checkHeadLimit(), checkBodyLimit() 함수 구현 (MCP23017 리미트 스위치 읽기)
    - initializeLimitSwitches(), monitorLimitSwitches() 함수 구현
    - _요구사항: 1.4, 7.2, 7.6_

  - [x] 15.2 LED 패턴 및 입력 처리 완성


    - decodePatternData() 함수 구현 (Master로부터 받은 패턴 데이터 디코딩)
    - showLEDPattern() 함수 완성 (문제 제시 LED 패턴 표시)
    - updateLEDPattern(), updateScoreLEDBlinking() 함수 완성
    - 입력 검증 및 Master로 결과 전송 로직 완성
    - _요구사항: 2.2, 2.3, 2.4, 4.2, 4.3_

  - [x] 15.3 유틸리티 함수 구현


    - updateAudioState() 함수 구현 (오디오 상태 관리)
    - checkMotorTimeout() 함수 구현 (모터 타임아웃 체크)
    - handleMotorBrake() 함수 구현 (모터 브레이크 처리)
    - 각종 테스트 및 디버그 함수들 완성
    - _요구사항: 7.2, 7.5_

- [x] 16. 전체 게임 플로우 통합 및 테스트




  - [x] 16.1 게임 시작 플로우 통합


    - 시작 버튼 입력 처리 및 게임 시작 시퀀스 완성
    - 천정 조명 → 로봇 회전 → 내레이션 플로우 검증
    - 각 단계별 타이밍 및 상태 전환 최적화
    - _요구사항: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [x] 16.2 게임 라운드 플로우 통합


    - 패턴 표시 → 입력 대기 → 검증 → 점수 업데이트 플로우 완성
    - 동작 감지 → 처벌 → 다음 라운드 플로우 완성
    - 레벨 진행 및 난이도 조절 시스템 검증
    - _요구사항: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 4.1, 4.4, 4.5, 5.1, 5.5_

  - [x] 16.3 게임 클리어 플로우 통합


    - 7점 달성 → 클리어 이펙트 → EM-Lock 작동 플로우 완성
    - 클리어 후 시스템 초기화 및 대기 상태 전환
    - _요구사항: 6.1, 6.2, 6.3, 6.4_

- [-] 17. 시스템 안정성 및 에러 처리 강화







  - [x] 17.1 통신 안정성 강화





    - Master-Slave 간 통신 오류 복구 메커니즘 완성
    - 통신 타임아웃 및 재시도 로직 최적화
    - 통신 상태 모니터링 및 진단 기능 추가
    - _요구사항: 7.3_

  - [x] 17.2 하드웨어 안전장치 강화





    - 모터 과부하 및 타임아웃 보호 강화
    - 센서 오작동 감지 및 복구 로직 추가
    - 전원 안정성 모니터링 및 보호 기능
    - _요구사항: 7.2, 7.6_

  - [x] 17.3 게임 로직 안정성 검증





    - 예외 상황에서의 게임 상태 복구 로직 완성
    - 사용자 입력 오류 처리 및 가이드 시스템
    - 시스템 리셋 및 초기화 기능 완성
    - _요구사항: 모든 요구사항 안정성 검증_

- [x] 18. 최종 시스템 검증 및 최적화




  - [x] 18.1 전체 시스템 통합 테스트


    - 모든 게임 시나리오에 대한 종합 테스트
    - 하드웨어 연동 및 타이밍 최적화
    - 사용자 경험 개선 및 피드백 반영
    - _요구사항: 모든 요구사항 최종 검증_

  - [x] 18.2 성능 최적화 및 마무리


    - 메모리 사용량 최적화 및 코드 정리
    - 게임 밸런싱 및 난이도 조절 최종 조정
    - 시스템 문서화 및 사용자 매뉴얼 작성
    - _요구사항: 8.1, 8.2, 8.3, 8.4, 8.5_